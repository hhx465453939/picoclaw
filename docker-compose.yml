services:
  # ─────────────────────────────────────────────
  # PicoClaw Agent (one-shot query)
  #   docker compose run --rm picoclaw-agent -m "Hello"
  # ─────────────────────────────────────────────
  picoclaw-agent:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: picoclaw-agent
    profiles:
      - agent
    volumes:
      - ./config/config.json:/root/.picoclaw/config.json:ro
      - picoclaw-workspace:/root/.picoclaw/workspace
    entrypoint: ["picoclaw", "agent"]
    stdin_open: true
    tty: true

  # ─────────────────────────────────────────────
  # PicoClaw Gateway (Long-running Bot)
  #   docker compose up picoclaw-gateway
  # ─────────────────────────────────────────────
  picoclaw-gateway:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: picoclaw-gateway
    restart: unless-stopped
    profiles:
      - gateway
    ports:
      # 宿主机 2222 -> 容器 22，从本机 SSH 登录容器：ssh -p 2222 root@<NAS_IP>
      - "2222:22"
    environment:
      # 可选：设置后可用密码登录容器。不设则需挂载 /root/.ssh/authorized_keys（见文档）
      - ROOT_PASSWORD=${GATEWAY_SSH_ROOT_PASSWORD:-}
    volumes:
      # Configuration file
      - ./config/config.json:/root/.picoclaw/config.json:ro
      # Persistent workspace (sessions, memory, logs)
      - picoclaw-workspace:/root/.picoclaw/workspace
      # 可选：本机公钥挂载为 root 的 authorized_keys，可免密 SSH 登录（与 ROOT_PASSWORD 二选一或同时用）
      # - ./config/ssh/authorized_keys:/root/.ssh/authorized_keys:ro
    command: ["gateway"]

volumes:
  picoclaw-workspace:
